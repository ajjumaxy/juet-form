<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>JUET Project Submission</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
html, body { height: 100%; margin: 0; }
.fixed-panel { position: fixed; top: 0; bottom: 0; overflow-y: auto; padding: 24px; box-sizing: border-box; }
.left-panel { left: 0; width: 48%; }
.right-panel { right: 0; width: 52%; }
@media (max-width: 900px) {
  .fixed-panel { position: static; width: 100%; height: auto; }
  .left-panel, .right-panel { width: 100%; }
}
</style>
</head>
<body class="bg-gray-100">

<!-- Left: Form -->
<div class="fixed-panel left-panel bg-white shadow-md rounded-r-xl">
  <h2 class="text-2xl font-semibold mb-4">Project Submission</h2>

  <form id="submitForm" class="space-y-4">
    <div>
      <label class="block font-medium">Enrollment Number</label>
      <input id="erno" class="w-full p-2 border rounded" required />
    </div>

    <div>
      <label class="block font-medium">Name</label>
      <input id="name" class="w-full p-2 border rounded" required />
    </div>

    <div>
      <label class="block font-medium">Supervisor Name</label>
      <input id="supervisor" class="w-full p-2 border rounded" required />
    </div>

    <div>
      <label class="block font-medium">Project Title</label>
      <input id="title" class="w-full p-2 border rounded" required />
    </div>

    <div>
      <label class="block font-medium">Auto Project Number (assigned)</label>
      <input id="pnum_display" class="w-full p-2 border rounded bg-gray-100" readonly />
    </div>

    <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded">Submit</button>
  </form>

  <p id="msg" class="text-green-600 font-semibold mt-3 hidden">Saved</p>

  <div class="mt-6 text-sm text-gray-600">
    <p>Only submission box is visible to normal users.</p>
    <p>Admin panel opens after entering the admin key.</p>
  </div>
</div>

<!-- Right: Admin panel -->
<div id="adminPanel" class="fixed-panel right-panel bg-white shadow-md rounded-l-xl hidden">
  <div class="flex items-center justify-between">
    <h2 class="text-2xl font-semibold mb-2">Submitted Records</h2>
    <div class="text-sm text-gray-600">Admin mode</div>
  </div>

  <div class="overflow-auto mt-3">
    <table class="w-full border text-sm" id="recordsTable">
      <thead>
        <tr class="bg-gray-100">
          <th class="border p-2">S.No</th>
          <th class="border p-2">Er.No</th>
          <th class="border p-2">Name</th>
          <th class="border p-2">Project No</th>
          <th class="border p-2">Title</th>
          <th class="border p-2">Supervisor</th>
        </tr>
      </thead>
      <tbody id="recordsBody"></tbody>
    </table>
  </div>

  <div class="grid grid-cols-1 gap-3 mt-4">
    <button onclick="exportCSV()" class="w-full bg-green-600 text-white p-2 rounded">Export CSV</button>
    <button onclick="exportJSON()" class="w-full bg-yellow-600 text-white p-2 rounded">Backup JSON</button>
    <button onclick="clearAll()" class="w-full bg-red-600 text-white p-2 rounded">Clear All Records</button>
  </div>
</div>

<script>
// Admin key
const ADMIN_KEY = "Guna@2000";
let isAdmin = false;

function getStoredRecords() {
  try { return JSON.parse(localStorage.getItem('juet_records') || '[]'); }
  catch (e) { return []; }
}

function setStoredRecords(rows) {
  localStorage.setItem('juet_records', JSON.stringify(rows));
}

// Render records grouped by project number
function loadLocalRecords() {
  const body = document.getElementById('recordsBody');
  body.innerHTML = '';
  const rows = getStoredRecords();
  if (!rows || rows.length === 0) return;

  const groups = {};
  rows.forEach(r => {
    if (!groups[r.pnum]) groups[r.pnum] = [];
    groups[r.pnum].push(r);
  });

  Object.keys(groups).sort().forEach(pnum => {
    const group = groups[pnum];

    // warning if more than 4
    if (group.length > 4) {
      const warn = document.createElement('tr');
      warn.innerHTML = `<td colspan='6' class='border p-2 bg-red-100 text-red-700 font-semibold'>Project ${pnum} has more than 4 students</td>`;
      body.appendChild(warn);
    }

    const header = document.createElement('tr');
    header.innerHTML = `<td colspan='6' class='border p-2 bg-gray-200 font-semibold'>Project Number ${pnum}</td>`;
    body.appendChild(header);

    group.forEach((r, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class='border p-2'>${i + 1}</td>
        <td class='border p-2'>${escapeHtml(r.erno)}</td>
        <td class='border p-2'>${escapeHtml(r.name)}</td>
        <td class='border p-2'>${escapeHtml(r.pnum)}</td>
        <td class='border p-2'>${escapeHtml(r.title)}</td>
        <td class='border p-2'>${escapeHtml(r.supervisor)}</td>`;
      body.appendChild(tr);
    });
  });
}

// Utility to escape HTML in table cells
function escapeHtml(s) {
  if (s === null || s === undefined) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Update display of auto project number when supervisor input changes
const supInput = document.getElementById('supervisor');
const pnumDisplay = document.getElementById('pnum_display');
if (supInput && pnumDisplay) {
  supInput.addEventListener('input', () => {
    const sup = supInput.value.trim();
    if (!sup) { pnumDisplay.value = ''; return; }
    const full = sup.replace(/\s+/g, '');
    const rows = getStoredRecords();
    const count = rows.filter(r => r.supervisor && r.supervisor.toLowerCase() === sup.toLowerCase()).length;
    pnumDisplay.value = full + (count + 1);
  });
}

// Form submit handler
document.getElementById('submitForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const erno = document.getElementById('erno').value.trim();
  const name = document.getElementById('name').value.trim();
  const supervisor = document.getElementById('supervisor').value.trim();
  const title = document.getElementById('title').value.trim();

  if (!erno || !name || !supervisor || !title) {
    alert('Please fill all fields.');
    return;
  }

  const fullName = supervisor.replace(/\s+/g, '');
  const rowsBefore = getStoredRecords();
  const count = rowsBefore.filter(r => r.supervisor && r.supervisor.toLowerCase() === supervisor.toLowerCase()).length;
  const pnum = fullName + (count + 1);

  const record = { erno, name, pnum, title, supervisor };

  const rows = getStoredRecords();
  rows.push(record);
  setStoredRecords(rows);

  // show saved message
  const msg = document.getElementById('msg');
  msg.classList.remove('hidden');
  setTimeout(() => msg.classList.add('hidden'), 1400);

  // refresh admin table if visible
  if (isAdmin) loadLocalRecords();

  // clear form and pnum display
  e.target.reset();
  if (pnumDisplay) pnumDisplay.value = '';
});

function exportCSV() {
  const rows = getStoredRecords();
  if (!rows || rows.length === 0) { alert('No records to export'); return; }
  let csv = 'Er.No,Name,Project No,Title,Supervisor\n';
  const esc = v => '"' + String(v).replace(/"/g,'""') + '"';
  rows.forEach(r => {
    csv += [esc(r.erno), esc(r.name), esc(r.pnum), esc(r.title), esc(r.supervisor)].join(',') + '\n';
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'juet_records.csv'; document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
}

function exportJSON() {
  const rows = getStoredRecords();
  if (!rows || rows.length === 0) { alert('No records to export'); return; }
  const data = JSON.stringify(rows, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'juet_backup.json'; document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
}

function clearAll() {
  if (!confirm('Clear all stored records? This cannot be undone.')) return;
  localStorage.removeItem('juet_records');
  loadLocalRecords();
}

function checkAdmin() {
  const key = prompt('Enter admin key');
  if (key === ADMIN_KEY) {
    isAdmin = true;
    document.getElementById('adminPanel').classList.remove('hidden');
    loadLocalRecords();
  } else {
    isAdmin = false;
    document.getElementById('adminPanel').classList.add('hidden');
  }
}
</script>


<!-- Admin Login Modal -->
<div id="adminLogin" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-6 rounded-xl shadow-lg w-80 text-center">
    <h2 class="text-xl font-semibold mb-4">Admin Login</h2>
    <input id="adminInput" type="password" placeholder="Enter admin key" class="w-full p-2 border rounded mb-4" />
    <button onclick="validateAdmin()" class="w-full bg-blue-600 text-white p-2 rounded">Login</button>
  </div>
</div>

<script>
function validateAdmin() {
  const key = document.getElementById('adminInput').value.trim();
  if (key === ADMIN_KEY) {
    isAdmin = true;
    document.getElementById('adminPanel').classList.remove('hidden');
    document.getElementById('adminLogin').classList.add('hidden');
    loadLocalRecords();
  } else {
    alert('Incorrect key');
  }
}
</script>
</body>
</html>
